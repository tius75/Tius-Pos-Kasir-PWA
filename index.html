<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir POS Tius System</title>
    <link rel="icon" href="favicon-32x32.png" type="image/png">  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { display: flex; min-height: 100vh; flex-direction: column; overflow-x: hidden; }
        #wrapper { display: flex; width: 100%; overflow: hidden; }
        #main-app-container { display: none; }
        .sidebar { width: 250px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; padding-top: 20px; position: sticky; top: 0; height: 100vh; overflow-y: auto; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 20px; }
        .nav-link { display: flex; align-items: center; padding: 10px 15px; color: #495057; text-decoration: none; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0d6efd; color: white; border-radius: 5px; }
        .nav-link:hover:not(.active) { background-color: #e2e6ea; }
        .nav-link i { margin-right: 10px; font-size: 1.2rem; }
        .product-img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
        .section { margin-bottom: 30px; border: 1px solid #ddd; border-radius: 5px; padding: 15px; background: white; }
        .section-title { border-bottom: 2px solid #0d6efd; padding-bottom: 10px; margin-bottom: 15px; color: #0d6efd; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .product-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; text-align: center; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-3px); }
        .product-card-img-container { width: 100%; height: 120px; overflow: hidden; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; }
        .product-card-img { width: 100%; height: 100%; object-fit: cover; }
        .product-card-body { padding: 10px; }
        .quick-menu button { padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 1rem; }
        .quick-menu button i { margin-bottom: 5px; font-size: 1.5rem; }

        @media (max-width: 768px) {
            .sidebar { display: none !important; }
            .main-content { width: 100%; margin-left: 0; padding-bottom: 70px; }
            .navbar { display: flex !important; width: 100%; }
            .mobile-footer-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background-color: #fff; border-top: 1px solid #dee2e6; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1030; justify-content: space-around; padding: 5px 0; }
            .mobile-footer-nav .nav-link { flex-direction: column; text-align: center; font-size: 0.75rem; padding: 5px 8px; color: #6c757d; border-radius: 5px; }
            .mobile-footer-nav .nav-link i { margin-right: 0; margin-bottom: 3px; font-size: 1.2rem; }
            .mobile-footer-nav .nav-link.active { background-color: #e9ecef; color: #0d6efd; }
        }

        @media (min-width: 769px) {
            .sidebar { display: flex !important; }
            .navbar { display: none !important; }
            .mobile-footer-nav { display: none; }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Kontainer Login -->
    <div id="login-container" style="height:100vh; background: linear-gradient(to right, #6a11cb, #2575fc); display: flex; justify-content: center; align-items: center;">
        <div class="card shadow" style="width: 100%; max-width: 400px;">
            <div class="card-body p-4">
                <h4 class="card-title text-center mb-4">Login ke Sistem Kasir</h4>
                <form id="login-form">
                    <div class="mb-3"><input class="form-control" id="email" placeholder="Email" required type="email"/></div>
                    <div class="mb-3"><input class="form-control" id="password" placeholder="Password" required type="password"/></div>
                    <button class="btn btn-primary w-100" type="submit">Login</button>
                    <div id="login-error" class="text-danger mt-2 text-center" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Kontainer Aplikasi Utama -->
    <div id="main-app-container">
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom no-print">
            <div class="container-fluid">
                <a class="navbar-brand text-primary ms-3" href="#">POS System</a>
                <div class="d-flex align-items-center">
                    <span id="user-greeting" class="text-muted small me-3"></span>
                    <button id="logout-btn-nav" class="btn btn-sm btn-outline-danger">Logout</button>
                </div>
            </div>
        </nav>
        <div class="d-flex" id="wrapper">
            <div class="sidebar d-flex flex-column p-3 no-print">
                <h3 class="text-primary mb-4 text-center"><i class="bi bi-cash-stack"></i> POS System</h3>
                <nav class="nav flex-column" id="sidebar-nav">
                    <a class="nav-link active" data-bs-toggle="tab" href="#dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a>
                    <a class="nav-link" data-bs-toggle="tab" href="#sales"><i class="bi bi-cart"></i> Penjualan</a>
                    <a class="nav-link" data-bs-toggle="tab" href="#stock-management"><i class="bi bi-box-seam"></i> Manajemen Stok</a>
                    <a class="nav-link" data-bs-toggle="tab" href="#transaction-history"><i class="bi bi-clock-history"></i> Riwayat Transaksi</a>
                    <a class="nav-link" data-bs-toggle="tab" href="#settings"><i class="bi bi-gear"></i> Pengaturan</a>
                </nav>
                <div class="mt-auto"><button id="logout-btn-sidebar" class="btn btn-danger w-100"><i class="bi bi-box-arrow-right"></i> Logout</button></div>
            </div>
            <div class="main-content tab-content" id="nav-tabContent">
                <!-- Dashboard Pane -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <div class="section">
                        <h2 class="section-title"><i class="bi bi-speedometer2"></i> Dashboard</h2>
                        <div class="quick-menu">
                            <button class="btn btn-success" id="quick-sales"><i class="bi bi-cart-fill"></i> Transaksi Penjualan</button>
                            <button class="btn btn-info" id="quick-add-product"><i class="bi bi-plus-square"></i> Tambah Produk</button>
                        </div>
                        <div class="row">
                            <div class="col-md-3"><div class="card text-white bg-primary mb-3"><div class="card-body"><h5 class="card-title">Penjualan Hari Ini</h5><h2 class="mb-0" id="today-sales">0</h2></div></div></div>
                            <div class="col-md-3"><div class="card text-white bg-success mb-3"><div class="card-body"><h5 class="card-title">Laba Hari Ini</h5><h2 class="mb-0" id="today-profit">0</h2></div></div></div>
                            <div class="col-md-3"><div class="card text-white bg-warning mb-3"><div class="card-body"><h5 class="card-title">Total Produk</h5><h2 class="mb-0" id="total-products">0</h2></div></div></div>
                            <div class="col-md-3"><div class="card text-white bg-info mb-3"><div class="card-body"><h5 class="card-title">Transaksi Pending</h5><h2 class="mb-0" id="pending-transactions-count">0</h2></div></div></div>
                        </div>
                    </div>
                </div>

                <!-- Sales Pane -->
                <div class="tab-pane fade" id="sales" role="tabpanel">
                    <div class="section">
                        <h2 class="section-title"><i class="bi bi-cart"></i> Penjualan</h2>
                        <div class="row">
                            <div class="col-md-7">
                                <input type="text" class="form-control mb-3" id="product-search" placeholder="Cari produk...">
                                <div id="product-list-sales" class="product-grid" style="max-height: 60vh; overflow-y: auto;"></div>
                            </div>
                            <div class="col-md-5">
                                <h5 class="mb-3">Keranjang</h5>
                                <div class="table-responsive" style="min-height: 40vh;">
                                    <table class="table table-sm" id="transaction-table">
                                        <thead><tr><th>Produk</th><th>Qty</th><th>Total</th><th></th></tr></thead>
                                        <tbody id="transaction-items"></tbody>
                                    </table>
                                </div>
                                <hr>
                                <h4 class="text-end">Total: <span id="transaction-total" class="text-primary">Rp 0</span></h4>
                                <div class="d-grid gap-2 mt-3"><button class="btn btn-primary" id="process-payment-btn"><i class="bi bi-credit-card"></i> Proses Pembayaran</button></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Management Pane -->
                <div class="tab-pane fade" id="stock-management" role="tabpanel">
                    <div class="section">
                        <h2 class="section-title"><i class="bi bi-box-seam"></i> Manajemen Produk</h2>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-plus-circle"></i> Tambah / Edit Produk</h5></div>
                                    <div class="card-body">
                                        <form id="product-form">
                                            <input type="hidden" id="product-id-hidden">
                                            <div class="mb-2"><label class="form-label">Nama Produk</label><input type="text" class="form-control" id="product-name" required></div>
                                            <div class="mb-2"><label class="form-label">Harga Beli</label><input type="number" class="form-control" id="product-buy-price" min="0" required></div>
                                            <div class="mb-2"><label class="form-label">Harga Jual</label><input type="number" class="form-control" id="product-sell-price" min="0" required></div>
                                            <div class="mb-3"><label class="form-label">Stok</label><input type="number" class="form-control" id="product-stock" min="0" required></div>
                                            <div class="d-grid gap-2">
                                                <button type="submit" class="btn btn-primary" id="save-product-btn"><i class="bi bi-save"></i> Simpan</button>
                                                <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display: none;"><i class="bi bi-x-circle"></i> Batal</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <input type="text" class="form-control mb-3" id="product-list-search" placeholder="Cari dalam daftar produk...">
                                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                                    <table class="table table-hover">
                                        <thead><tr><th>Nama</th><th>Harga Beli</th><th>Harga Jual</th><th>Stok</th><th>Aksi</th></tr></thead>
                                        <tbody id="product-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction History Pane -->
                <div class="tab-pane fade" id="transaction-history" role="tabpanel">
                    <div class="section">
                        <h2 class="section-title"><i class="bi bi-clock-history"></i> Riwayat Transaksi</h2>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr><th>ID Transaksi</th><th>Tanggal</th><th>Item</th><th>Total</th><th>Aksi</th></tr></thead>
                                <tbody id="history-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Pane -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <div class="section">
                        <h2 class="section-title"><i class="bi bi-gear"></i> Pengaturan</h2>
                        <div class="row">
                             <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header"><h5 class="mb-0">Pengaturan Toko (Struk)</h5></div>
                                    <div class="card-body">
                                        <form id="store-settings-form">
                                            <div class="mb-3"><label class="form-label">Nama Toko</label><input type="text" id="store-name" class="form-control" value="Toko Maju Jaya"></div>
                                            <div class="mb-3"><label class="form-label">Alamat</label><input type="text" id="store-address" class="form-control" value="Jl. Raya No. 123"></div>
                                            <div class="mb-3"><label class="form-label">Telepon</label><input type="text" id="store-phone" class="form-control" value="081234567890"></div>
                                            <div class="mb-3"><label class="form-label">Pesan Footer</label><input type="text" id="receipt-footer" class="form-control" value="Terima kasih!"></div>
                                            <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Pembayaran -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Pembayaran</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <h4 class="mb-3">Total Belanja: <span id="payment-modal-total"></span></h4>
                    <div class="mb-3"><label class="form-label">Jumlah Dibayar</label><input type="number" class="form-control" id="amount-paid"></div>
                    <h5>Kembalian: <span id="change-amount"></span></h5>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="complete-payment-btn">Selesaikan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Struk -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Struk</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="receipt-content" style="font-family: 'Courier New', monospace;"></div>
                <div class="modal-footer">
                     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" onclick="window.print();">Cetak</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";

        // --- Konfigurasi ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVCynAyWLPqwhkEx4dR0k5J_OsL-0Q_rY",
            authDomain: "kasir-toko-70d61.firebaseapp.com",
            projectId: "kasir-toko-70d61",
            storageBucket: "kasir-toko-70d61.appspot.com",
            messagingSenderId: "1057810583954",
            appId: "1:1057810583954:web:788e1058ad4a07eb84f14b"
        };

        // --- Inisialisasi Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variabel Global & State ---
        let products = [];
        let transactions = [];
        let currentTransaction = { items: [], total: 0 };
        let editingProductId = null;
        let unsubscribeProducts, unsubscribeTransactions;
        let paymentModalInstance, receiptModalInstance;

        // --- Referensi Elemen DOM ---
        const loginContainer = document.getElementById('login-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const userGreeting = document.getElementById('user-greeting');
        const productTableBody = document.getElementById('product-table-body');
        const productForm = document.getElementById('product-form');
        const historyList = document.getElementById('history-list');

        // --- Logika Otentikasi ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.style.display = 'none';
                mainAppContainer.style.display = 'block';
                userGreeting.textContent = `Halo, ${user.email}`;
                initApplication();
            } else {
                loginContainer.style.display = 'flex';
                mainAppContainer.style.display = 'none';
                if (unsubscribeProducts) unsubscribeProducts();
                if (unsubscribeTransactions) unsubscribeTransactions();
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, password).catch(err => {
                document.getElementById('login-error').textContent = "Login Gagal: " + err.message;
                document.getElementById('login-error').style.display = 'block';
            });
        });
        
        document.getElementById('logout-btn-nav').addEventListener('click', () => signOut(auth));
        document.getElementById('logout-btn-sidebar').addEventListener('click', () => signOut(auth));

        // --- Fungsi Utama Aplikasi ---
        function initApplication() {
            listenForProducts();
            listenForTransactions();
            setupEventListeners();
            paymentModalInstance = new bootstrap.Modal(document.getElementById('paymentModal'));
            receiptModalInstance = new bootstrap.Modal(document.getElementById('receiptModal'));
        }

        function setupEventListeners() {
            // Manajemen Produk
            productForm.addEventListener('submit', handleProductFormSubmit);
            document.getElementById('cancel-edit-btn').addEventListener('click', resetProductForm);
            document.getElementById('product-list-search').addEventListener('input', (e) => renderProductTable(e.target.value));

            // Penjualan
            document.getElementById('product-search').addEventListener('input', (e) => renderSalesProductList(e.target.value));
            document.getElementById('process-payment-btn').addEventListener('click', processPayment);
            document.getElementById('complete-payment-btn').addEventListener('click', completePayment);
            document.getElementById('amount-paid').addEventListener('input', calculateChange);

            // Navigasi Cepat Dashboard
            document.getElementById('quick-sales').addEventListener('click', () => new bootstrap.Tab(document.querySelector('a[href="#sales"]')).show());
            document.getElementById('quick-add-product').addEventListener('click', () => new bootstrap.Tab(document.querySelector('a[href="#stock-management"]')).show());
        
            // Pengaturan
            document.getElementById('store-settings-form').addEventListener('submit', saveSettings);
            loadSettings();
        }

        // --- Listener Firestore ---
        function listenForProducts() {
            if (unsubscribeProducts) unsubscribeProducts();
            const productsCol = collection(db, "products");
            unsubscribeProducts = onSnapshot(productsCol, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductTable();
                renderSalesProductList();
                updateDashboard();
            }, console.error);
        }

        function listenForTransactions() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            const q = query(collection(db, "transactions"), orderBy("timestamp", "desc"));
            unsubscribeTransactions = onSnapshot(q, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory();
                updateDashboard();
            }, console.error);
        }

        // --- Render UI ---
        function renderProductTable(searchTerm = '') {
            productTableBody.innerHTML = '';
            const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            filtered.forEach(p => {
                const row = productTableBody.insertRow();
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${formatCurrency(p.buyPrice)}</td>
                    <td>${formatCurrency(p.sellPrice)}</td>
                    <td>${p.stock}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-product" data-id="${p.id}"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger delete-product" data-id="${p.id}"><i class="bi bi-trash"></i></button>
                    </td>`;
            });
            productTableBody.querySelectorAll('.edit-product').forEach(b => b.addEventListener('click', (e) => editProduct(e.currentTarget.dataset.id)));
            productTableBody.querySelectorAll('.delete-product').forEach(b => b.addEventListener('click', (e) => deleteProduct(e.currentTarget.dataset.id)));
        }

        function renderSalesProductList(searchTerm = '') {
            const container = document.getElementById('product-list-sales');
            container.innerHTML = '';
            const filtered = products.filter(p => p.stock > 0 && p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            filtered.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card p-2';
                card.innerHTML = `<h6>${p.name}</h6><p>${formatCurrency(p.sellPrice)}</p>`;
                card.onclick = () => addToCart(p.id);
                container.appendChild(card);
            });
        }
        
        function renderTransactionItems() {
            const tbody = document.getElementById('transaction-items');
            tbody.innerHTML = '';
            currentTransaction.items.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <i class="bi bi-dash-circle-fill text-danger me-2" onclick="updateCartItem(${index}, -1)"></i>
                        ${item.quantity}
                        <i class="bi bi-plus-circle-fill text-success ms-2" onclick="updateCartItem(${index}, 1)"></i>
                    </td>
                    <td>${formatCurrency(item.quantity * item.price)}</td>
                    <td><i class="bi bi-x-circle text-danger" onclick="removeCartItem(${index})"></i></td>`;
            });
            currentTransaction.total = currentTransaction.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            document.getElementById('transaction-total').textContent = formatCurrency(currentTransaction.total);
        }

        function renderHistory() {
            historyList.innerHTML = '';
            transactions.forEach(t => {
                const date = t.timestamp ? t.timestamp.toDate().toLocaleString('id-ID') : 'N/A';
                const row = historyList.insertRow();
                row.innerHTML = `
                    <td>${t.id.substring(0, 8)}</td>
                    <td>${date}</td>
                    <td>${t.items.length}</td>
                    <td>${formatCurrency(t.total)}</td>
                    <td><button class="btn btn-sm btn-info view-receipt" data-id="${t.id}"><i class="bi bi-eye"></i></button></td>`;
            });
            historyList.querySelectorAll('.view-receipt').forEach(b => b.addEventListener('click', (e) => viewReceipt(e.currentTarget.dataset.id)));
        }

        function updateDashboard() {
            document.getElementById('total-products').textContent = products.length;
            const today = new Date().toISOString().split('T')[0];
            const todaySales = transactions
                .filter(t => t.timestamp && t.timestamp.toDate().toISOString().split('T')[0] === today)
                .reduce((sum, t) => sum + t.total, 0);
            document.getElementById('today-sales').textContent = formatCurrency(todaySales);
        }

        // --- Manajemen Produk ---
        async function handleProductFormSubmit(e) {
            e.preventDefault();
            if (!auth.currentUser) return alert("Harus login!");
            const productData = {
                name: document.getElementById('product-name').value,
                buyPrice: parseFloat(document.getElementById('product-buy-price').value),
                sellPrice: parseFloat(document.getElementById('product-sell-price').value),
                stock: parseInt(document.getElementById('product-stock').value)
            };
            try {
                if (editingProductId) {
                    await setDoc(doc(db, "products", editingProductId), productData, { merge: true });
                } else {
                    await addDoc(collection(db, "products"), productData);
                }
                resetProductForm();
            } catch (error) { console.error("Error saving product: ", error); }
        }

        function editProduct(id) {
            const p = products.find(prod => prod.id === id);
            if (!p) return;
            editingProductId = id;
            document.getElementById('product-id-hidden').value = p.id;
            document.getElementById('product-name').value = p.name;
            document.getElementById('product-buy-price').value = p.buyPrice;
            document.getElementById('product-sell-price').value = p.sellPrice;
            document.getElementById('product-stock').value = p.stock;
            document.getElementById('save-product-btn').textContent = 'Update';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
        }

        async function deleteProduct(id) {
            if (confirm('Yakin hapus produk ini?')) {
                try { await deleteDoc(doc(db, "products", id)); }
                catch (error) { console.error("Error deleting product: ", error); }
            }
        }
        
        function resetProductForm() {
            productForm.reset();
            editingProductId = null;
            document.getElementById('save-product-btn').textContent = 'Simpan';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }
        
        // --- Logika Penjualan ---
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock < 1) return;
            const existingItem = currentTransaction.items.find(item => item.id === productId);
            if (existingItem) {
                if(existingItem.quantity < product.stock) existingItem.quantity++;
            } else {
                currentTransaction.items.push({ id: product.id, name: product.name, price: product.sellPrice, quantity: 1 });
            }
            renderTransactionItems();
        }
        
        window.updateCartItem = function(index, change) {
            const item = currentTransaction.items[index];
            const product = products.find(p => p.id === item.id);
            if(item.quantity + change > 0 && item.quantity + change <= product.stock) {
                item.quantity += change;
            }
            renderTransactionItems();
        }

        window.removeCartItem = function(index) {
            currentTransaction.items.splice(index, 1);
            renderTransactionItems();
        }
        
        function processPayment() {
            if (currentTransaction.items.length === 0) return alert("Keranjang kosong!");
            document.getElementById('payment-modal-total').textContent = formatCurrency(currentTransaction.total);
            document.getElementById('amount-paid').value = currentTransaction.total;
            calculateChange();
            paymentModalInstance.show();
        }
        
        async function completePayment() {
            const transactionToSave = { ...currentTransaction, timestamp: serverTimestamp() };
            try {
                // Kurangi stok
                for (const item of transactionToSave.items) {
                    const productRef = doc(db, "products", item.id);
                    const product = products.find(p => p.id === item.id);
                    await setDoc(productRef, { stock: product.stock - item.quantity }, { merge: true });
                }
                // Simpan transaksi
                await addDoc(collection(db, "transactions"), transactionToSave);
                paymentModalInstance.hide();
                viewReceipt(null, transactionToSave); // Tampilkan struk dari data sementara
                currentTransaction = { items: [], total: 0 }; // Reset keranjang
                renderTransactionItems();
            } catch (error) { console.error("Error completing payment: ", error); }
        }
        
        function calculateChange() {
            const total = currentTransaction.total;
            const paid = parseFloat(document.getElementById('amount-paid').value) || 0;
            const change = paid - total;
            document.getElementById('change-amount').textContent = formatCurrency(Math.max(0, change));
        }

        function viewReceipt(transactionId, transactionData = null) {
            const transaction = transactionData || transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            const settings = getSettings();
            let itemsHtml = '';
            transaction.items.forEach(item => {
                itemsHtml += `<div>${item.name}</div><div style="text-align: right;">${item.quantity} x ${formatCurrency(item.price)} = ${formatCurrency(item.quantity * item.price)}</div>`;
            });

            document.getElementById('receipt-content').innerHTML = `
                <div class="text-center">
                    <h5>${settings.storeName}</h5>
                    <p>${settings.storeAddress}<br>${settings.storePhone}</p>
                </div>
                <hr>
                ${itemsHtml}
                <hr>
                <div style="text-align: right; font-weight: bold;">TOTAL: ${formatCurrency(transaction.total)}</div>
                <hr>
                <p class="text-center">${settings.receiptFooter}</p>
            `;
            receiptModalInstance.show();
        }

        // --- Pengaturan ---
        function saveSettings(e) {
            e.preventDefault();
            const settings = {
                storeName: document.getElementById('store-name').value,
                storeAddress: document.getElementById('store-address').value,
                storePhone: document.getElementById('store-phone').value,
                receiptFooter: document.getElementById('receipt-footer').value
            };
            localStorage.setItem('posSettings', JSON.stringify(settings));
            alert("Pengaturan disimpan!");
        }

        function loadSettings() {
            const settings = getSettings();
            document.getElementById('store-name').value = settings.storeName;
            document.getElementById('store-address').value = settings.storeAddress;
            document.getElementById('store-phone').value = settings.storePhone;
            document.getElementById('receipt-footer').value = settings.receiptFooter;
        }
        
        function getSettings() {
            return JSON.parse(localStorage.getItem('posSettings')) || {
                storeName: 'Toko Anda', storeAddress: 'Alamat Anda', storePhone: 'Telepon Anda', receiptFooter: 'Terima Kasih'
            };
        }

        // --- Helper ---
        function formatCurrency(amount) {
            return `Rp ${Number(amount).toLocaleString('id-ID')}`;
        }
    </script>
</body>
</html>

