<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir POS Tius System</title>
    <link rel="manifest" href="app.webmanifest">
    <meta name="theme-color" content="#D30000">
    <link rel="apple-touch-icon" href="logo192.png">
    <link rel="icon" type="image/png" href="favicon32.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { display: flex; min-height: 100vh; flex-direction: column; overflow-x: hidden; }
        #wrapper { display: flex; width: 100%; overflow: hidden; }
        .sidebar { width: 250px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; padding-top: 20px; position: sticky; top: 0; height: 100vh; overflow-y: auto; flex-shrink: 0; transition: margin-left 0.3s ease, transform 0.3s ease; }
        .main-content { flex-grow: 1; padding: 20px; transition: margin-left 0.3s ease; }
        .nav-link { display: flex; align-items: center; padding: 10px 15px; color: #495057; text-decoration: none; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0d6efd; color: white; border-radius: 5px; }
        .nav-link:hover:not(.active) { background-color: #e2e6ea; }
        .nav-link i { margin-right: 10px; font-size: 1.2rem; }
        .receipt { font-family: 'Courier New', monospace; width: 100%; max-width: 400px; margin: 0 auto; padding: 15px; border: 1px dashed #ccc; background-color: white; box-sizing: border-box; }
        .receipt-header, .receipt-footer { text-align: center; margin: 10px 0; }
        .receipt-item { display: flex; justify-content: space-between; margin: 3px 0; }
        .receipt-total { font-weight: bold; border-top: 1px dashed #000; padding-top: 5px; margin-top: 5px; }
        @media print { .no-print { display: none !important; } body { background: none; margin: 0; padding: 0; } .container { width: auto; max-width: none; padding: 0; } .sidebar, .navbar, .modal-footer, .mobile-footer-nav { display: none !important; } .main-content { padding: 0; margin-left: 0 !important; } #wrapper { display: block; } }
        .product-img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
        .section { margin-bottom: 30px; border: 1px solid #ddd; border-radius: 5px; padding: 15px; background: white; }
        .section-title { border-bottom: 2px solid #0d6efd; padding-bottom: 10px; margin-bottom: 15px; color: #0d6efd; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .product-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; text-align: center; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-3px); }
        .product-card-img-container { width: 100%; height: 120px; overflow: hidden; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; }
        .product-card-img { width: 100%; height: 100%; object-fit: cover; }
        .product-card-body { padding: 10px; }
        .product-card-body h6 { margin-bottom: 5px; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-card-body p { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .product-card-body .btn { font-size: 0.85rem; padding: 5px 10px; }
        @media (max-width: 768px) { .sidebar { display: none !important; } .main-content { width: 100%; margin-left: 0; padding-bottom: 70px; } .navbar { display: flex !important; width: 100%; } #wrapper.toggled::after { display: none; } #pendingModal .modal-dialog { margin: 0; width: 100%; height: 100%; max-width: none; } #pendingModal .modal-content { height: 100%; border-radius: 0; } #pendingModal .modal-body { overflow-y: auto; } .mobile-footer-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background-color: #fff; border-top: 1px solid #dee2e6; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1030; padding: 5px 0; } .mobile-footer-nav .nav-link { flex-direction: column; text-align: center; font-size: 0.75rem; padding: 5px 8px; color: #6c757d; transition: color 0.2s, background-color 0.2s; border-radius: 5px; } .mobile-footer-nav .nav-link i { margin-right: 0; margin-bottom: 3px; font-size: 1.2rem; } .mobile-footer-nav .nav-link.active { background-color: #e9ecef; color: #0d6efd; } }
        @media (min-width: 769px) { .sidebar { position: sticky; transform: translateX(0%); display: flex !important; } .main-content { margin-left: 0; padding-bottom: 20px; } .navbar { display: none !important; } .mobile-footer-nav { display: none; } }
        .sync-status { position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; font-size: 12px; z-index: 1000; }
        .sync-status.online { background-color: #28a745; color: white; } .sync-status.offline { background-color: #dc3545; color: white; } .sync-status.syncing { background-color: #ffc107; color: black; }
        .quick-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .quick-menu button { padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 1rem; }
        .quick-menu button i { margin-bottom: 5px; font-size: 1.5rem; }
        .edit-row { background-color: #f0f8ff; } .edit-row input[type="number"], .edit-row input[type="text"] { width: 80px; }
    </style>
</head>
<body class="bg-light">

    <div id="login-container" style="display: none; height: 100vh; background: linear-gradient(to right, rgb(106, 17, 203), rgb(37, 117, 252)); justify-content: center; align-items: center;">
      <div class="card shadow" style="width: 100%; max-width: 400px;">
        <div class="card-body">
          <h4 class="card-title text-center mb-4">Login ke Sistem Kasir</h4>
          <form id="login-form">
            <div class="mb-3"> <input class="form-control" id="email" placeholder="Email" required="" type="email"/> </div>
            <div class="mb-3"> <input class="form-control" id="password" placeholder="Password" required="" type="password"/> </div>
            <button class="btn btn-primary w-100" type="submit">Login</button>
          </form>
        </div>
      </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom no-print" style="display: none;">
        <div class="container-fluid">
            <a class="navbar-brand text-primary ms-3" href="#">POS System</a>
            <div class="d-flex align-items-center"> <span class="text-muted small">Halo, User!</span> </div>
        </div>
    </nav>

    <div class="d-flex" id="wrapper" style="display: none;">
        <div class="sidebar d-flex flex-column p-3 no-print">
            <h3 class="text-primary mb-4 text-center"><i class="bi bi-cash-stack"></i> POS System</h3>
            <nav class="nav flex-column" id="sidebar-nav">
                <a class="nav-link active" id="nav-dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="true"> <i class="bi bi-speedometer2"></i> Dashboard </a>
                <a class="nav-link" id="nav-sales-tab" data-bs-toggle="tab" href="#sales" role="tab" aria-controls="sales" aria-selected="false"> <i class="bi bi-cart"></i> Penjualan </a>
                <a class="nav-link" id="nav-stock-tab" data-bs-toggle="tab" href="#stock-management" role="tab" aria-controls="stock-management" aria-selected="false"> <i class="bi bi-box-seam"></i> Manajemen Stok </a>
                <a class="nav-link" id="nav-report-tab" data-bs-toggle="tab" href="#profit-loss-report" role="tab" aria-controls="profit-loss-report" aria-selected="false"> <i class="bi bi-graph-up"></i> Laporan Rugi Laba </a>
                <a class="nav-link" id="nav-history-tab" data-bs-toggle="tab" href="#transaction-history" role="tab" aria-controls="transaction-history" aria-selected="false"> <i class="bi bi-clock-history"></i> Riwayat Transaksi </a>
                <a class="nav-link" id="nav-backup-tab" data-bs-toggle="tab" href="#backup-restore" role="tab" aria-controls="backup-restore" aria-selected="false"> <i class="bi bi-database"></i> Backup & Restore </a>
                <a class="nav-link" id="nav-settings-tab" data-bs-toggle="tab" href="#settings" role="tab" aria-controls="settings" aria-selected="false"> <i class="bi bi-gear"></i> Pengaturan </a>
            </nav>
        </div>

        <div class="main-content tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="nav-dashboard-tab">
                <div class="section">
                    <h2 class="section-title"><i class="bi bi-speedometer2"></i> Dashboard</h2>
                    <div class="quick-menu">
                        <button class="btn btn-success" id="quick-sales"> <i class="bi bi-cart-fill"></i> Transaksi Penjualan </button>
                        <button class="btn btn-info" id="quick-add-product"> <i class="bi bi-plus-square"></i> Tambah Produk </button>
                    </div>
                    <div class="row">
                        <div class="col-md-3"><div class="card text-white bg-primary mb-3"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><h5 class="card-title">Penjualan Hari Ini</h5><h2 class="mb-0" id="today-sales">0</h2></div><i class="bi bi-cart fs-1"></i></div></div></div></div>
                        <div class="col-md-3"><div class="card text-white bg-success mb-3"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><h5 class="card-title">Laba Hari Ini</h5><h2 class="mb-0" id="today-profit">0</h2></div><i class="bi bi-currency-dollar fs-1"></i></div></div></div></div>
                        <div class="col-md-3"><div class="card text-white bg-warning mb-3"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><h5 class="card-title">Total Produk</h5><h2 class="mb-0" id="total-products">0</h2></div><i class="bi bi-box fs-1"></i></div></div></div></div>
                        <div class="col-md-3"><div class="card text-white bg-info mb-3"><div class="card-body"><div class="d-flex justify-content-between align-items-center"><div><h5 class="card-title">Transaksi Pending</h5><h2 class="mb-0" id="pending-transactions">0</h2></div><i class="bi bi-hourglass-split fs-1"></i></div></div></div></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="nav-sales-tab">
                <div class="section">
                    <h2 class="section-title"><i class="bi bi-cart"></i> Penjualan</h2>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row mb-3 align-items-end">
                                <div class="col-md-6 mb-2 mb-md-0"><div class="input-group"><span class="input-group-text"><i class="bi bi-search"></i></span><input type="text" class="form-control" id="product-search" placeholder="Cari produk..."></div></div>
                                <div class="col-md-3 col-6"><div class="btn-group w-100" role="group"><button class="btn btn-outline-primary active" id="view-list-btn" title="Tampilan Daftar"><i class="bi bi-list-ul"></i></button><button class="btn btn-outline-primary" id="view-grid-btn" title="Tampilan Kotak"><i class="bi bi-grid"></i></button></div></div>
                                <div class="col-md-3 col-6"><button class="btn btn-outline-secondary w-100" id="show-pending"><i class="bi bi-hourglass"></i> Pending (<span id="pending-count">0</span>)</button></div>
                            </div>
                            <div id="product-display-area" class="mb-3"><div class="table-responsive" id="product-table-view"><table class="table table-bordered table-hover"><thead class="table-light"><tr><th>Produk</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead><tbody id="product-list"></tbody></table></div><div id="product-grid-view" class="product-grid" style="display: none;"></div></div>
                            <h5 class="mb-3">Items Transaksi</h5>
                            <div class="table-responsive"><table class="table table-bordered table-hover" id="transaction-table"><thead class="table-light"><tr><th>Produk</th><th>Harga</th><th>Qty</th><th>Total</th><th>Aksi</th></tr></thead><tbody id="transaction-items"></tbody></table></div>
                            <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap"><h4 class="mb-0">Total: <span id="transaction-total" class="text-primary">0</span></h4><div class="d-flex flex-wrap mt-2 mt-md-0"><button class="btn btn-outline-danger me-2 mb-2 mb-md-0" id="save-pending"><i class="bi bi-hourglass"></i> Simpan Pending</button><button class="btn btn-primary" id="process-payment"><i class="bi bi-credit-card"></i> Proses Pembayaran</button></div></div>
                        </div>
                        <div class="col-md-4 d-none"></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="stock-management" role="tabpanel" aria-labelledby="nav-stock-tab">
                <div class="section">
                    <h2 class="section-title"><i class="bi bi-box-seam"></i> Manajemen Produk</h2>
                    <div class="row">
                        <div class="col-md-4"><div class="card mb-4"><div class="card-header bg-primary text-white"><h3 class="mb-0"><i class="bi bi-plus-circle"></i> Tambah / Edit Produk</h3></div><div class="card-body"><form id="product-form"><input type="hidden" id="product-id-hidden"><div class="mb-3"><label for="product-name" class="form-label">Nama Produk</label><input type="text" class="form-control" id="product-name" required></div><div class="mb-3"><label for="product-buy-price" class="form-label">Harga Beli</label><input type="number" class="form-control" id="product-buy-price" min="0" required></div><div class="mb-3"><label for="product-sell-price" class="form-label">Harga Jual</label><input type="text" class="form-control" id="product-sell-price" required></div><div class="mb-3"><label for="product-stock" class="form-label">Stok Awal</label><input type="number" class="form-control" id="product-stock" min="0" value="0" required></div><div class="mb-3"><label for="product-image-upload" class="form-label">Gambar Produk</label><input type="file" class="form-control" id="product-image-upload" accept="image/*"><small class="form-text text-muted">Akan diunggah ke Cloudinary. Jika tidak diisi, akan menggunakan gambar default.</small><div id="product-image-preview" class="mt-2 text-center" style="display: none;"><img src="" alt="Preview" style="max-width: 100px; max-height: 100px; border: 1px solid #ddd; border-radius: 5px;"><p class="small text-muted mb-0">Preview</p></div></div><div class="d-grid gap-2"><button type="submit" class="btn btn-primary" id="save-product-btn"><i class="bi bi-save"></i> Simpan Produk</button><button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display: none;"><i class="bi bi-x-circle"></i> Batal Edit</button></div></form></div></div></div>
                        <div class="col-md-8"><div class="card"><div class="card-header bg-success text-white"><div class="d-flex justify-content-between align-items-center"><h3 class="mb-0"><i class="bi bi-box-seam"></i> Daftar Produk</h3><div class="input-group" style="width: 300px;"><span class="input-group-text"><i class="bi bi-search"></i></span><input type="text" class="form-control" id="product-list-search" placeholder="Cari produk..."></div></div></div><div class="card-body" style="max-height: 400px; overflow-y: auto;"><table class="table table-hover"><thead><tr><th>Gambar</th><th>Nama</th><th>Harga Beli</th><th>Harga Jual</th><th>Stok</th><th>Aksi</th></tr></thead><tbody id="product-table-body"></tbody></table></div></div></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="profit-loss-report" role="tabpanel" aria-labelledby="nav-report-tab">
                <div class="section">
                    <h2 class="section-title"><i class="bi bi-graph-up"></i> Laporan Rugi Laba</h2>
                    <div class="row mb-4 g-3"><div class="col-md-3 col-6"><label for="report-start-date" class="form-label">Tanggal Mulai</label><input type="date" class="form-control" id="report-start-date"></div><div class="col-md-3 col-6"><label for="report-end-date" class="form-label">Tanggal Akhir</label><input type="date" class="form-control" id="report-end-date"></div><div class="col-md-3 col-12"><label for="report-product-filter" class="form-label">Filter Produk</label><select class="form-select" id="report-product-filter"><option value="all">Semua Produk</option></select></div><div class="col-md-3 col-12 d-flex align-items-end gap-2"><button class="btn btn-primary flex-grow-1" id="generate-report"><i class="bi bi-arrow-repeat"></i> Generate</button><button class="btn btn-info flex-grow-1" id="download-report-pdf"><i class="bi bi-file-earmark-pdf"></i> PDF</button></div></div>
                    <ul class="nav nav-tabs mb-3" id="reportTabs" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#report-summary-content" type="button" role="tab">Ringkasan</button></li><li class="nav-item" role="presentation"><button class="nav-link" id="item-profit-tab" data-bs-toggle="tab" data-bs-target="#report-item-profit-content" type="button" role="tab">Rugi Laba per Item</button></li><li class="nav-item" role="presentation"><button class="nav-link" id="stock-report-tab" data-bs-toggle="tab" data-bs-target="#report-stock-content" type="button" role="tab">Stok per Item</button></li></ul>
                    <div class="tab-content"><div class="tab-pane fade show active" id="report-summary-content" role="tabpanel"><div class="row"><div class="col-md-6"><div class="card mb-4"><div class="card-header bg-success text-white"><h4 class="mb-0">Ringkasan Laporan</h4></div><div class="card-body"><table class="table"><tr><th>Total Penjualan</th><td id="report-total-sales">0</td></tr><tr><th>Total Pembelian (HPP)</th><td id="report-total-purchases">0</td></tr><tr class="table-primary"><th>Laba Kotor</th><td id="report-gross-profit">0</td></tr></table></div></div></div><div class="col-md-6"><div class="card"><div class="card-header bg-info text-white"><h4 class="mb-0">Detail Transaksi</h4></div><div class="card-body" style="max-height: 300px; overflow-y: auto;"><table class="table table-hover"><thead><tr><th>Tanggal</th><th>ID Transaksi</th><th>Total</th><th>Laba</th></tr></thead><tbody id="report-transactions"></tbody></table></div></div></div></div></div><div class="tab-pane fade" id="report-item-profit-content" role="tabpanel"><div class="card"><div class="card-header bg-primary text-white"><h4 class="mb-0">Laporan Penjualan & Laba per Item</h4></div><div class="card-body" style="max-height: 400px; overflow-y: auto;"><table class="table table-hover"><thead><tr><th>Nama Produk</th><th>Terjual (Qty)</th><th>Total Penjualan</th><th>Total HPP</th><th>Total Laba</th></tr></thead><tbody id="report-item-profit-table"><tr><td colspan="5" class="text-center">Generate laporan terlebih dahulu.</td></tr></tbody></table></div></div></div><div class="tab-pane fade" id="report-stock-content" role="tabpanel"><div class="card"><div class="card-header bg-warning text-white"><h4 class="mb-0">Laporan Stok Produk</h4></div><div class="card-body" style="max-height: 400px; overflow-y: auto;"><table class="table table-hover"><thead><tr><th>Nama Produk</th><th>Stok Tersedia</th><th>Harga Beli</th><th>Harga Jual</th></tr></thead><tbody id="report-stock-table"><tr><td colspan="4" class="text-center">Data stok terkini.</td></tr></tbody></table></div></div></div></div>
                </div>
            </div>

            <div class="tab-pane fade" id="transaction-history" role="tabpanel" aria-labelledby="nav-history-tab">
                <div class="section">
                    <h2 class="section-title"><i class="bi bi-clock-history"></i> Riwayat Transaksi</h2>
                    <div class="row mb-4 g-3 align-items-end">
                        <div class="col-md-4"><label for="history-start-date" class="form-label">Dari Tanggal</label><input type="date" class="form-control" id="history-start-date"></div>
                        <div class="col-md-4"><label for="history-end-date" class="form-label">Sampai Tanggal</label><input type="date" class="form-control" id="history-end-date"></div>
                        <div class="col-md-4"><button class="btn btn-primary w-100" id="filter-history-btn"><i class="bi bi-filter"></i> Terapkan Filter</button></div>
                    </div>
                    <div class="card"><div class="card-body" style="max-height: 500px; overflow-y: auto;"><table class="table table-hover"><thead><tr><th>ID Transaksi</th><th>Tanggal</th><th>Items</th><th>Total</th><th>Aksi</th></tr></thead><tbody id="history-list"></tbody></table></div></div>
                </div>
            </div>

            <div class="tab-pane fade" id="backup-restore" role="tabpanel" aria-labelledby="nav-backup-tab">
                <div class="section">
                    <h2 class="section-title"><i class="bi bi-database"></i> Backup & Restore Data</h2>
                    <div class="row">
                        <div class="col-md-6"><div class="card mb-4"><div class="card-header bg-primary text-white"><h3 class="mb-0"><i class="bi bi-download"></i> Backup Data</h3></div><div class="card-body"><div class="mb-3"><label class="form-label">Pilih Data untuk Backup</label><div class="form-check"><input class="form-check-input" type="checkbox" id="backup-products" checked><label class="form-check-label" for="backup-products">Data Produk</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="backup-transactions" checked><label class="form-check-label" for="backup-transactions">Data Transaksi</label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="backup-pending" checked><label class="form-check-label" for="backup-pending">Transaksi Pending</label></div></div><button class="btn btn-primary w-100" id="backup-data"><i class="bi bi-download"></i> Backup Data</button></div></div></div>
                        <div class="col-md-6"><div class="card"><div class="card-header bg-success text-white"><h3 class="mb-0"><i class="bi bi-upload"></i> Restore Data</h3></div><div class="card-body"><div class="mb-3"><label for="restore-file" class="form-label">Pilih File Backup</label><input type="file" class="form-control" id="restore-file" accept=".json"></div><div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Restore akan mengganti data yang ada. Pastikan Anda sudah membackup data terbaru.</div><button class="btn btn-success w-100" id="restore-data"><i class="bi bi-upload"></i> Restore Data</button></div></div></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="nav-settings-tab">
                <div class="section">
                    <h2 class="section-title"><i class="bi bi-gear"></i> Pengaturan Aplikasi</h2>
                    <div class="row">
                        <div class="col-md-6"><div class="card mb-4"><div class="card-header bg-info text-white"><h3 class="mb-0"><i class="bi bi-shop"></i> Pengaturan Toko (Struk)</h3></div><div class="card-body"><form id="store-settings-form"><div class="mb-3"><label for="store-name" class="form-label">Nama Toko</label><input type="text" class="form-control" id="store-name" placeholder="Nama Toko Anda" required></div><div class="mb-3"><label for="store-address" class="form-label">Alamat Toko</label><textarea class="form-control" id="store-address" rows="3" placeholder="Alamat lengkap toko Anda" required></textarea></div><div class="mb-3"><label for="store-phone" class="form-label">Nomor Telepon</label><input type="tel" class="form-control" id="store-phone" placeholder="Contoh: 081234567890"></div><div class="mb-3"><label for="receipt-footer" class="form-label">Pesan Footer Struk</label><textarea class="form-control" id="receipt-footer" rows="2" placeholder="Terima kasih atas kunjungan Anda!"></textarea></div><button type="submit" class="btn btn-primary w-100"><i class="bi bi-save"></i> Simpan Pengaturan Toko</button></form></div></div></div>
                        <div class="col-md-6"><div class="card mb-4"><div class="card-header bg-warning text-white"><h3 class="mb-0"><i class="bi bi-printer"></i> Pengaturan Printer</h3></div><div class="card-body"><div class="mb-3"><label for="printer-paper-size" class="form-label">Ukuran Kertas Struk</label><select class="form-select" id="printer-paper-size"><option value="58mm">58mm (Kecil)</option><option value="80mm">80mm (Standar)</option><option value="custom">Ukuran Kustom (via browser)</option></select></div><div class="mb-3"><label for="print-preview" class="form-label">Pratinjau Cetak</label><select class="form-select" id="print-preview"><option value="yes">Ya (Buka dialog cetak browser)</option><option value="no">Tidak (Cetak langsung - *Tidak direkomendasikan untuk web*)</option></select><small class="form-text text-muted">Untuk web, umumnya cetak selalu melalui dialog cetak browser.</small></div><button class="btn btn-primary w-100 mt-3" id="save-printer-settings"><i class="bi bi-save"></i> Simpan Pengaturan Printer</button><div class="alert alert-info mt-3"><i class="bi bi-info-circle"></i> **Catatan:** Pengaturan printer di aplikasi web ini terbatas. Browser Anda akan tetap menampilkan dialog cetak standar. Pastikan printer kasir Anda sudah terhubung dan diatur sebagai printer default sistem Anda untuk hasil terbaik.</div></div></div><div class="card"><div class="card-header bg-secondary text-white"><h3 class="mb-0"><i class="bi bi-wrench"></i> Pengaturan Lainnya</h3></div><div class="card-body"><div class="mb-3"><label for="currency-symbol" class="form-label">Simbol Mata Uang</label><input type="text" class="form-control" id="currency-symbol" value="Rp" required></div><button class="btn btn-primary w-100" id="save-other-settings"><i class="bi bi-save"></i> Simpan Pengaturan Lain</button></div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pendingModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Transaksi Pending</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div class="mb-3"><label for="pending-customer-name" class="form-label">Nama Pelanggan (untuk transaksi pending)</label><input type="text" class="form-control" id="pending-customer-name" placeholder="Masukkan nama pelanggan"></div><table class="table table-hover"><thead><tr><th>ID</th><th>Tanggal</th><th>Pelanggan</th><th>Items</th><th>Total</th><th>Aksi</th></tr></thead><tbody id="pending-transactions-list"></tbody></table></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button></div></div></div></div>
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true"><div class="modal-dialog modal-md"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title" id="paymentModalLabel"><i class="bi bi-calculator"></i> Proses Pembayaran</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><h4 class="text-center mb-3">Total Belanja: <span id="payment-modal-total" class="text-primary fw-bold">Rp 0</span></h4><div class="mb-3"><label for="payment-method" class="form-label">Metode Pembayaran</label><select class="form-select" id="payment-method"><option value="cash">Tunai</option><option value="debit">Kartu Debit</option><option value="credit">Kartu Kredit</option><option value="transfer">Transfer Bank</option></select></div><div class="mb-3"><label for="customer-name" class="form-label">Nama Pelanggan (Opsional)</label><input type="text" class="form-control" id="customer-name" placeholder="Nama pelanggan"></div><div class="mb-3"><label for="amount-paid" class="form-label">Jumlah Dibayar</label><input type="text" class="form-control" id="amount-paid" value="0"></div><div class="mb-3"><label class="form-label">Kembalian</label><div class="form-control bg-light" id="change-amount">0</div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-success" id="complete-payment"><i class="bi bi-check-circle"></i> Selesaikan Pembayaran</button></div></div></div></div>
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Struk Pembayaran</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div id="receipt-content"></div></div><div class="modal-footer no-print"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button><button type="button" class="btn btn-primary" id="print-receipt"><i class="bi bi-printer"></i> Cetak</button><button type="button" class="btn btn-info" id="share-receipt-image"><i class="bi bi-share"></i> Share Image</button></div></div></div></div>
    <div class="sync-status offline" id="syncStatus"><i class="bi bi-wifi-off"></i> Offline Mode</div>
    <nav class="mobile-footer-nav no-print nav justify-content-around" style="display: none;">
        <a class="nav-link active" id="footer-dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="true"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a>
        <a class="nav-link" id="footer-sales-tab" data-bs-toggle="tab" href="#sales" role="tab" aria-controls="sales" aria-selected="false"><i class="bi bi-cart"></i> <span>Penjualan</span></a>
        <a class="nav-link" id="footer-stock-tab" data-bs-toggle="tab" href="#stock-management" role="tab" aria-controls="stock-management" aria-selected="false"><i class="bi bi-box-seam"></i> <span>Stok</span></a>
        <a class="nav-link" id="footer-history-tab" data-bs-toggle="tab" href="#transaction-history" role="tab" aria-controls="transaction-history" aria-selected="false"><i class="bi bi-clock-history"></i> <span>Riwayat</span></a>
        <a class="nav-link" id="footer-settings-tab" data-bs-toggle="tab" href="#settings" role="tab" aria-controls="settings" aria-selected="false"><i class="bi bi-gear"></i> <span>Pengaturan</span></a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- Configuration ---
        const CLOUDINARY_CLOUD_NAME = 'ganti_dengan_cloud_name_anda';
        const CLOUDINARY_UPLOAD_PRESET = 'ganti_dengan_upload_preset_anda';

        // Local storage keys
        const LOCAL_PRODUCTS_KEY = 'pos_products';
        const LOCAL_TRANSACTIONS_KEY = 'pos_transactions';
        const LOCAL_PENDING_KEY = 'pos_pending_transactions';
        const LOCAL_LAST_SYNC_KEY = 'pos_last_sync';

        // Initialize variables
        let products = [];
        let transactions = [];
        let pendingTransactions = [];
        let settings = JSON.parse(localStorage.getItem('pos_settings')) || {
            storeName: 'Toko Maju Jaya',
            storeAddress: 'Jl. Raya No. 123, Bekasi',
            storePhone: '021-1234567',
            receiptFooter: 'Terima kasih atas kunjungan Anda!',
            printerPaperSize: '80mm',
            printPreview: 'yes',
            currencySymbol: 'Rp ',
            syncEnabled: true
        };
        let currentTransaction = { id: null, date: null, items: [], customerName: '', paymentMethod: 'cash', amountPaid: 0, change: 0, total: 0, profit: 0 };
        let editingProductId = null;
        let currentProductView = 'list';
        let isOnline = navigator.onLine;
        let currentlyEditingTransactionId = null; 

        // DOM elements
        const syncStatusElement = document.getElementById('syncStatus');
        const todaySalesElement = document.getElementById('today-sales');
        const todayProfitElement = document.getElementById('today-profit');
        const totalProductsElement = document.getElementById('total-products');
        const pendingTransactionsElement = document.getElementById('pending-transactions');
        const productSearchElement = document.getElementById('product-search');
        const productTableView = document.getElementById('product-table-view');
        const productGridView = document.getElementById('product-grid-view');
        const viewListBtn = document.getElementById('view-list-btn');
        const viewGridBtn = document.getElementById('view-grid-btn');
        const productListElement = document.getElementById('product-list');
        const transactionItemsElement = document.getElementById('transaction-items');
        const transactionTotalElement = document.getElementById('transaction-total');
        const savePendingBtn = document.getElementById('save-pending');
        const processPaymentBtn = document.getElementById('process-payment');
        const showPendingBtn = document.getElementById('show-pending');
        const pendingCountElement = document.getElementById('pending-count');
        const productForm = document.getElementById('product-form');
        const productIdHidden = document.getElementById('product-id-hidden');
        const productNameInput = document.getElementById('product-name');
        const productBuyPriceInput = document.getElementById('product-buy-price');
        const productSellPriceInput = document.getElementById('product-sell-price');
        const productStockInput = document.getElementById('product-stock');
        const productImageUpload = document.getElementById('product-image-upload');
        const productImagePreview = document.querySelector('#product-image-preview img');
        const productImagePreviewContainer = document.getElementById('product-image-preview');
        const saveProductBtn = document.getElementById('save-product-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const productTableBody = document.getElementById('product-table-body');
        const productListSearch = document.getElementById('product-list-search');
        const reportStartDate = document.getElementById('report-start-date');
        const reportEndDate = document.getElementById('report-end-date');
        const reportProductFilter = document.getElementById('report-product-filter');
        const generateReportBtn = document.getElementById('generate-report');
        const downloadReportPdfBtn = document.getElementById('download-report-pdf');
        const reportTotalSales = document.getElementById('report-total-sales');
        const reportTotalPurchases = document.getElementById('report-total-purchases');
        const reportGrossProfit = document.getElementById('report-gross-profit');
        const reportTransactions = document.getElementById('report-transactions');
        const reportItemProfitTable = document.getElementById('report-item-profit-table');
        const reportStockTable = document.getElementById('report-stock-table');
        const backupBtn = document.getElementById('backup-data');
        const restoreFile = document.getElementById('restore-file');
        const restoreBtn = document.getElementById('restore-data');
        const pendingModal = new bootstrap.Modal(document.getElementById('pendingModal'));
        const pendingTransactionsList = document.getElementById('pending-transactions-list');
        const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
        const receiptContent = document.getElementById('receipt-content');
        const printReceiptBtn = document.getElementById('print-receipt');
        const shareReceiptImageBtn = document.getElementById('share-receipt-image');
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const paymentModalTotal = document.getElementById('payment-modal-total');
        const paymentMethodElement = document.getElementById('payment-method');
        const customerNameElement = document.getElementById('customer-name');
        const amountPaidElement = document.getElementById('amount-paid');
        const changeAmountElement = document.getElementById('change-amount');
        const completePaymentBtn = document.getElementById('complete-payment');
        const historyList = document.getElementById('history-list');
        const storeNameInput = document.getElementById('store-name');
        const storeAddressInput = document.getElementById('store-address');
        const storePhoneInput = document.getElementById('store-phone');
        const receiptFooterInput = document.getElementById('receipt-footer');
        const storeSettingsForm = document.getElementById('store-settings-form');
        const quickSalesBtn = document.getElementById('quick-sales');
        const quickAddProductBtn = document.getElementById('quick-add-product');
        const mobileFooterNav = document.querySelector('.mobile-footer-nav');

        function updateSyncStatus() { if (isOnline) { syncStatusElement.innerHTML = '<i class="bi bi-wifi"></i> Online'; syncStatusElement.className = 'sync-status online'; } else { syncStatusElement.innerHTML = '<i class="bi bi-wifi-off"></i> Offline'; syncStatusElement.className = 'sync-status offline'; } }
        window.addEventListener('online', () => { isOnline = true; updateSyncStatus(); if (settings.syncEnabled) syncData(); });
        window.addEventListener('offline', () => { isOnline = false; updateSyncStatus(); });
        function generateId() { return 'local_' + Date.now().toString() + '_' + Math.floor(Math.random() * 1000); }
        async function syncData() {}
        async function fetchProducts() {}
        async function fetchTransactions() {}
        async function fetchPendingTransactions() {}
        async function saveProductToFirestore(productData, productId = null) {}
        async function deleteProductFromFirestore(productId) {}
        async function saveTransactionToFirestore(transactionData) {}
        async function savePendingTransactionToFirestore(transactionData, pendingId = null) {}
        async function deletePendingTransactionFromFirestore(pendingId) {}
        function loadDashboard() {}
        function loadProducts(searchTerm = '', view = 'list') {}
        
        async function deleteTransaction(transactionId) {
            if (currentlyEditingTransactionId === transactionId) {
                cancelEditTransaction(transactionId);
            }
            if (!confirm('Yakin ingin menghapus transaksi ini?')) return;
            transactions = transactions.filter(t => t.id !== transactionId);
            localStorage.setItem(LOCAL_TRANSACTIONS_KEY, JSON.stringify(transactions));
            if (isOnline && settings.syncEnabled) {
                await firebase.firestore().collection('transactions').doc(transactionId).delete();
            }
            loadHistory();
            loadDashboard();
            alert('Transaksi berhasil dihapus!');
        }
        
        function loadHistory() {
            const startDateInput = document.getElementById('history-start-date');
            const endDateInput = document.getElementById('history-end-date');
            const startDateStr = startDateInput.value;
            const endDateStr = endDateInput.value;
            const filteredTransactions = transactions.filter(t => {
                if (!t || !t.date) return false;
                const transactionDateStr = t.date.split('T')[0];
                const afterStartDate = startDateStr ? transactionDateStr >= startDateStr : true;
                const beforeEndDate = endDateStr ? transactionDateStr <= endDateStr : true;
                return afterStartDate && beforeEndDate;
            });
            historyList.innerHTML = '';
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (filteredTransactions.length === 0) {
                historyList.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada transaksi pada rentang tanggal yang dipilih.</td></tr>';
                return;
            }
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', transaction.id);
                row.innerHTML = `<td class="text-break small">#${transaction.id.substring(0, 10)}...</td><td class="small">${new Date(transaction.date).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</td><td class="small">${transaction.items.length} items</td><td class="fw-bold text-end">${formatCurrency(transaction.total)}</td><td class="text-nowrap"><button class="btn btn-sm btn-info mb-1" onclick="viewReceipt('${transaction.id}')" title="Lihat Struk"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-warning mb-1" onclick="enableEditTransaction('${transaction.id}')" title="Edit Transaksi"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')" title="Hapus Transaksi"><i class="bi bi-trash"></i></button></td>`;
                historyList.appendChild(row);
            });
        }

        function enableEditTransaction(transactionId) {
            if (currentlyEditingTransactionId && currentlyEditingTransactionId !== transactionId) cancelEditTransaction(currentlyEditingTransactionId);
            if (currentlyEditingTransactionId === transactionId) { cancelEditTransaction(transactionId); return; }
            currentlyEditingTransactionId = transactionId;
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            const historyRow = document.querySelector(`#history-list tr[data-id='${transactionId}']`);
            if (!historyRow) return;
            const actionCell = historyRow.querySelector('td:last-child');
            actionCell.innerHTML = `<button class="btn btn-sm btn-success" onclick="saveTransactionChanges('${transactionId}')"><i class="bi bi-check-circle"></i> Simpan</button><button class="btn btn-sm btn-secondary" onclick="cancelEditTransaction('${transactionId}')"><i class="bi bi-x-circle"></i> Batal</button>`;
            let editRowsHtml = '';
            transaction.items.forEach((item, index) => {
                const product = products.find(p => p.id === item.productId);
                editRowsHtml += `<tr class="transaction-edit-item-row" data-parent-id="${transactionId}"><td class="text-end small pt-3" colspan="2"><em>${item.namaBarang}</em></td><td><label class="form-label-sm">Qty</label><input type="number" class="form-control form-control-sm" value="${item.kuantitas}" data-original-qty="${item.kuantitas}" data-product-id="${item.productId}" id="edit-qty-${transactionId}-${index}"></td><td><label class="form-label-sm">Harga Jual</label><input type="text" class="form-control form-control-sm" value="${formatNumberForInput(item.hargaBarang)}" id="edit-price-${transactionId}-${index}"></td><td></td></tr>`;
            });
            historyRow.insertAdjacentHTML('afterend', editRowsHtml);
        }

        function cancelEditTransaction(transactionId) {
            document.querySelectorAll(`.transaction-edit-item-row[data-parent-id='${transactionId}']`).forEach(row => row.remove());
            const historyRow = document.querySelector(`#history-list tr[data-id='${transactionId}']`);
            if (historyRow) {
                const actionCell = historyRow.querySelector('td:last-child');
                actionCell.innerHTML = `<button class="btn btn-sm btn-info mb-1" onclick="viewReceipt('${transactionId}')" title="Lihat Struk"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-warning mb-1" onclick="enableEditTransaction('${transactionId}')" title="Edit Transaksi"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transactionId}')" title="Hapus Transaksi"><i class="bi bi-trash"></i></button>`;
            }
            currentlyEditingTransactionId = null;
        }

        async function saveTransactionChanges(transactionId) {
            const editRows = document.querySelectorAll(`.transaction-edit-item-row[data-parent-id='${transactionId}']`);
            let updatedItems = [], stockUpdates = {}, isValid = true;
            const transaction = transactions.find(t => t.id === transactionId);
            editRows.forEach((row, index) => {
                if(!isValid) return;
                const qtyInput = document.getElementById(`edit-qty-${transactionId}-${index}`);
                const priceInput = document.getElementById(`edit-price-${transactionId}-${index}`);
                const newQty = parseInt(qtyInput.value), newPrice = parseFloat(priceInput.value.replace(/[^0-9.]/g, ""));
                const originalQty = parseInt(qtyInput.dataset.originalQty), productId = qtyInput.dataset.productId;
                const product = products.find(p => p.id === productId), originalItem = transaction.items[index];
                const stockChange = originalQty - newQty;
                if (product && newQty > originalQty && (newQty - originalQty) > product.stock) { alert(`Stok untuk ${product.name} tidak mencukupi!`); isValid = false; }
                updatedItems.push({ ...originalItem, kuantitas: newQty, hargaBarang: newPrice, total: newQty * newPrice });
                stockUpdates[productId] = (stockUpdates[productId] || 0) + stockChange;
            });
            if (!isValid) return;
            try {
                for (const productId in stockUpdates) {
                    const product = products.find(p => p.id === productId);
                    if (product) await saveProductToFirestore({ stock: product.stock + stockUpdates[productId] }, productId);
                }
                const transactionToUpdate = transactions.find(t => t.id === transactionId);
                transactionToUpdate.items = updatedItems;
                transactionToUpdate.total = updatedItems.reduce((sum, i) => sum + i.total, 0);
                transactionToUpdate.profit = updatedItems.reduce((sum, i) => { const prod = products.find(p => p.id === i.productId); return sum + ((i.hargaBarang - (prod?.buyPrice || 0)) * i.kuantitas); }, 0);
                await updateTransactionInFirestore(transactionToUpdate);
                alert('Transaksi berhasil diperbarui!');
                cancelEditTransaction(transactionId);
                await fetchProducts();
                await fetchTransactions();
            } catch (error) { alert('Gagal menyimpan perubahan: ' + error); }
        }

        async function updateTransactionInFirestore(transactionData) {
            const localIndex = transactions.findIndex(t => t.id === transactionData.id);
            if (localIndex !== -1) transactions[localIndex] = transactionData;
            localStorage.setItem(LOCAL_TRANSACTIONS_KEY, JSON.stringify(transactions));
            if (isOnline && settings.syncEnabled) {
                await firebase.firestore().collection('transactions').doc(transactionData.id).set(transactionData, { merge: true });
            }
        }
    </script>

    <script>
        // SCRIPT INISIALISASI & LOGIN
        const firebaseConfig = {
            apiKey: "AIzaSyBVCynAyWLPqwhkEx4dR0k5J_OsL-0Q_rY",
            authDomain: "kasir-toko-70d61.firebaseapp.com",
            projectId: "kasir-toko-70d61",
            storageBucket: "kasir-toko-70d61.appspot.com",
            messagingSenderId: "1057810583954",
            appId: "1:1057810583954:web:788e1058ad4a07eb84f14b"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        db.enablePersistence().catch((err) => {
            if (err.code == 'failed-precondition') console.error("Gagal persistensi, tab lain terbuka.", err);
            else if (err.code == 'unimplemented') console.error("Browser tidak mendukung persistensi.", err);
        });

        document.getElementById("login-form").addEventListener("submit", (e) => {
            e.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            auth.signInWithEmailAndPassword(email, password).catch(err => alert("Login gagal: " + err.message));
        });

        auth.onAuthStateChanged(user => {
            const loginContainer = document.getElementById("login-container");
            const navBar = document.querySelector(".navbar");
            const wrapper = document.getElementById("wrapper");
            const mobileFooterNav = document.querySelector('.mobile-footer-nav');
            if (user) {
                loginContainer.style.display = "none";
                navBar.style.display = "";
                wrapper.style.display = "";
                mobileFooterNav.style.display = "";
                if (typeof init === 'function') init();
            } else {
                loginContainer.style.display = "flex";
                navBar.style.display = "none";
                wrapper.style.display = "none";
                mobileFooterNav.style.display = "none";
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker: Registered'))
                    .catch(err => console.log('Service Worker: Registration Failed:', err));
            });
        }
        
        function init() {
            // ... fungsi init yang sesungguhnya ada di script block pertama ...
            // Anda bisa memindahkan semua logika init ke sini jika mau, tapi untuk sekarang biarkan
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
