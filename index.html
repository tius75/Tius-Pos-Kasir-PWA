<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir POS Tius System</title>
    <link rel="manifest" href="app.webmanifest">
    <meta name="theme-color" content="#D30000">
    <link rel="apple-touch-icon" href="logo192.png">
    <link rel="icon" type="image/png" href="favicon32.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { display: flex; min-height: 100vh; flex-direction: column; overflow-x: hidden; }
        #wrapper { display: flex; width: 100%; overflow: hidden; }
        .sidebar { width: 250px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; padding-top: 20px; position: sticky; top: 0; height: 100vh; overflow-y: auto; flex-shrink: 0; transition: margin-left 0.3s ease, transform 0.3s ease; }
        .main-content { flex-grow: 1; padding: 20px; transition: margin-left 0.3s ease; }
        .nav-link { display: flex; align-items: center; padding: 10px 15px; color: #495057; text-decoration: none; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #0d6efd; color: white; border-radius: 5px; }
        .nav-link:hover:not(.active) { background-color: #e2e6ea; }
        .nav-link i { margin-right: 10px; font-size: 1.2rem; }
        .receipt { font-family: 'Courier New', monospace; width: 100%; max-width: 400px; margin: 0 auto; padding: 15px; border: 1px dashed #ccc; background-color: white; box-sizing: border-box; }
        .receipt-header, .receipt-footer { text-align: center; margin: 10px 0; }
        .receipt-item { display: flex; justify-content: space-between; margin: 3px 0; }
        .receipt-total { font-weight: bold; border-top: 1px dashed #000; padding-top: 5px; margin-top: 5px; }
        @media print { .no-print { display: none !important; } body { background: none; margin: 0; padding: 0; } .container { width: auto; max-width: none; padding: 0; } .sidebar, .navbar, .modal-footer, .mobile-footer-nav { display: none !important; } .main-content { padding: 0; margin-left: 0 !important; } #wrapper { display: block; } }
        .product-img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
        .section { margin-bottom: 30px; border: 1px solid #ddd; border-radius: 5px; padding: 15px; background: white; }
        .section-title { border-bottom: 2px solid #0d6efd; padding-bottom: 10px; margin-bottom: 15px; color: #0d6efd; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .product-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; text-align: center; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-3px); }
        .product-card-img-container { width: 100%; height: 120px; overflow: hidden; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; }
        .product-card-img { width: 100%; height: 100%; object-fit: cover; }
        .product-card-body { padding: 10px; }
        .product-card-body h6 { margin-bottom: 5px; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-card-body p { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .product-card-body .btn { font-size: 0.85rem; padding: 5px 10px; }
        @media (max-width: 768px) { .sidebar { display: none !important; } .main-content { width: 100%; margin-left: 0; padding-bottom: 70px; } .navbar { display: flex !important; width: 100%; } #wrapper.toggled::after { display: none; } #pendingModal .modal-dialog { margin: 0; width: 100%; height: 100%; max-width: none; } #pendingModal .modal-content { height: 100%; border-radius: 0; } #pendingModal .modal-body { overflow-y: auto; } .mobile-footer-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background-color: #fff; border-top: 1px solid #dee2e6; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 1030; justify-content: space-around; padding: 5px 0; } .mobile-footer-nav .nav-link { flex-direction: column; text-align: center; font-size: 0.75rem; padding: 5px 8px; color: #6c757d; transition: color 0.2s, background-color 0.2s; border-radius: 5px; } .mobile-footer-nav .nav-link i { margin-right: 0; margin-bottom: 3px; font-size: 1.2rem; } .mobile-footer-nav .nav-link.active { background-color: #e9ecef; color: #0d6efd; } }
        @media (min-width: 769px) { .sidebar { position: sticky; transform: translateX(0%); display: flex !important; } .main-content { margin-left: 0; padding-bottom: 20px; } .navbar { display: none !important; } .mobile-footer-nav { display: none; } }
        .sync-status { position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; font-size: 12px; z-index: 1000; }
        .sync-status.online { background-color: #28a745; color: white; } .sync-status.offline { background-color: #dc3545; color: white; } .sync-status.syncing { background-color: #ffc107; color: black; }
        .quick-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .quick-menu button { padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 1rem; }
        .quick-menu button i { margin-bottom: 5px; font-size: 1.5rem; }
        .edit-row { background-color: #f0f8ff; } .edit-row input[type="number"], .edit-row input[type="text"] { width: 80px; }
    </style>
</head>
<body class="bg-light">

  <div id="login-container" style="display: none; height: 100vh; background: linear-gradient(to right, #6a11cb, #2575fc); justify-content: center; align-items: center;">
      <div class="card shadow" style="width: 100%; max-width: 400px;">
        <div class="card-body">
          <h4 class="card-title text-center mb-4">Login ke Sistem Kasir</h4>
          <form id="login-form">
            <div class="mb-3"> <input class="form-control" id="email" placeholder="Email" required="" type="email"/> </div>
            <div class="mb-3"> <input class="form-control" id="password" placeholder="Password" required="" type="password"/> </div>
            <button class="btn btn-primary w-100" type="submit">Login</button>
          </form>
        </div>
      </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom no-print" style="display: none;">
      <div class="container-fluid">
          <a class="navbar-brand text-primary ms-3" href="#">POS System</a>
          <div class="d-flex align-items-center"> <span class="text-muted small">Halo, User!</span> </div>
      </div>
  </nav>

  <div class="d-flex" id="wrapper" style="display: none;">
      <div class="sidebar d-flex flex-column p-3 no-print">
          <h3 class="text-primary mb-4 text-center"><i class="bi bi-cash-stack"></i> POS System</h3>
          <nav class="nav flex-column" id="sidebar-nav">
              <a class="nav-link active" id="nav-dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab"> <i class="bi bi-speedometer2"></i> Dashboard </a>
              <a class="nav-link" id="nav-sales-tab" data-bs-toggle="tab" href="#sales" role="tab"> <i class="bi bi-cart"></i> Penjualan </a>
              <a class="nav-link" id="nav-stock-tab" data-bs-toggle="tab" href="#stock-management" role="tab"> <i class="bi bi-box-seam"></i> Manajemen Stok </a>
              <a class="nav-link" id="nav-report-tab" data-bs-toggle="tab" href="#profit-loss-report" role="tab"> <i class="bi bi-graph-up"></i> Laporan Rugi Laba </a>
              <a class="nav-link" id="nav-history-tab" data-bs-toggle="tab" href="#transaction-history" role="tab"> <i class="bi bi-clock-history"></i> Riwayat Transaksi </a>
              <a class="nav-link" id="nav-backup-tab" data-bs-toggle="tab" href="#backup-restore" role="tab"> <i class="bi bi-database"></i> Backup & Restore </a>
              <a class="nav-link" id="nav-settings-tab" data-bs-toggle="tab" href="#settings" role="tab"> <i class="bi bi-gear"></i> Pengaturan </a>
          </nav>
      </div>

      <div class="main-content tab-content" id="nav-tabContent">
          </div>
  </div>

  <div class="modal fade" id="pendingModal" tabindex="-1"> </div>
  <div class="modal fade" id="paymentModal" tabindex="-1"> </div>
  <div class="modal fade" id="receiptModal" tabindex="-1"> </div>

  <div class="sync-status offline" id="syncStatus"> <i class="bi bi-wifi-off"></i> Offline Mode </div>

  <nav class="mobile-footer-nav no-print nav justify-content-around" style="display: none;">
      <a class="nav-link active" id="footer-dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab"> <i class="bi bi-speedometer2"></i> <span>Dashboard</span> </a>
      <a class="nav-link" id="footer-sales-tab" data-bs-toggle="tab" href="#sales" role="tab"> <i class="bi bi-cart"></i> <span>Penjualan</span> </a>
      <a class="nav-link" id="footer-stock-tab" data-bs-toggle="tab" href="#stock-management" role="tab"> <i class="bi bi-box-seam"></i> <span>Stok</span> </a>
      <a class="nav-link" id="footer-history-tab" data-bs-toggle="tab" href="#transaction-history" role="tab"> <i class="bi bi-clock-history"></i> <span>Riwayat</span> </a>
      <a class="nav-link" id="footer-settings-tab" data-bs-toggle="tab" href="#settings" role="tab"> <i class="bi bi-gear"></i> <span>Pengaturan</span> </a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    // SEMUA LOGIKA APLIKASI UTAMA (TIDAK BERUBAH)
    // DARI FILE ASLI ANDA
    const CLOUDINARY_CLOUD_NAME = 'ganti_dengan_cloud_name_anda';
    const CLOUDINARY_UPLOAD_PRESET = 'ganti_dengan_upload_preset_anda';
    // ... dan semua sisa kode di dalam tag <script> pertama Anda ...
    // Note: Pastikan tidak ada `firebase.initializeApp` di dalam blok ini.
  </script>

  <script>
    // SCRIPT BARU UNTUK INISIALISASI & LOGIN (MENGGANTIKAN <script type="module">)
    const firebaseConfig = {
        apiKey: "AIzaSyBVCynAyWLPqwhkEx4dR0k5J_OsL-0Q_rY", // Ganti dengan API Key Anda yang valid
        authDomain: "kasir-toko-70d61.firebaseapp.com",
        projectId: "kasir-toko-70d61",
        storageBucket: "kasir-toko-70d61.appspot.com",
        messagingSenderId: "1057810583954",
        appId: "1:1057810583954:web:788e1058ad4a07e8b4f14b"
    };
    
    // Lakukan inisialisasi Firebase HANYA SATU KALI
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore(); // Inisialisasi Firestore setelah app diinisialisasi

    // Aktifkan persistensi setelah db diinisialisasi
    db.enablePersistence().catch((err) => {
        if (err.code == 'failed-precondition') {
            console.error("Gagal mengaktifkan persistensi. Tab lain mungkin terbuka.", err);
        } else if (err.code == 'unimplemented') {
            console.error("Browser ini tidak mendukung persistensi offline.", err);
        }
    });

    document.getElementById("login-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                // Jangan reload, cukup tampilkan UI aplikasi
            })
            .catch(err => {
                alert("Login gagal: " + err.message);
            });
    });

    auth.onAuthStateChanged(user => {
        const loginContainer = document.getElementById("login-container");
        const navBar = document.querySelector(".navbar");
        const wrapper = document.getElementById("wrapper");
        const mobileFooterNav = document.querySelector('.mobile-footer-nav');

        if (user) {
            // User login: Tampilkan aplikasi, sembunyikan login
            loginContainer.style.display = "none";
            navBar.style.display = "";
            wrapper.style.display = "";
            mobileFooterNav.style.display = "";
            
            if (typeof init === 'function') {
                init(); // Jalankan fungsi setup utama aplikasi
            }
        } else {
            // User tidak login: Tampilkan login, sembunyikan aplikasi
            loginContainer.style.display = "flex";
            navBar.style.display = "none";
            wrapper.style.display = "none";
            mobileFooterNav.style.display = "none";
        }
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registered! Scope:', reg.scope))
                .catch(err => console.log('Service Worker registration failed:', err));
        });
    }
  </script>

</body>
</html>
